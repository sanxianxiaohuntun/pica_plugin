# 漫画搜索下载插件

## 简介

这是一个用于搜索和下载漫画的插件，支持搜索漫画和下载图片，并使用合并转发功能发送。插件支持在群聊和私聊中使用，会将多页漫画自动分批合并成多个长图显示，提供更好的阅读体验。
## 安装
```
!plugin get https://github.com/sanxianxiaohuntun/pica_plugin
```
## 功能

1. **搜索漫画**：根据关键词搜索漫画，支持翻页
2. **下载漫画**：根据漫画ID下载指定漫画的所有章节
3. **智能图片合并**：自动将多页漫画分批合并成长图，避免单图过长
4. **合并转发**：使用合并转发方式发送漫画预览（支持群聊和私聊）
5. **批量章节下载**：一次下载漫画的所有章节并发送

## 命令

- `搜漫画 关键词 [页码]`：搜索漫画，可指定页码
- `看漫画 漫画ID`：下载漫画所有章节并发送
- `漫画帮助`：显示帮助信息

## 配置

配置文件位于`yaml/config.yaml`，包含以下配置项：

```yaml
# 账号配置
account: ""  # 账号
password: ""  # 密码
proxy: null  # 代理服务器地址，如 "http://127.0.0.1:7890"

# 合并转发消息配置
forward:
  sender_name: "漫画"
  sender_id: "3870128501"

# 其他设置
max_preview_pages: 10  # 预览图片数量上限
max_search_results: 10  # 搜索结果显示数量上限
max_image_height: 20000  # 单批图片合并的最大高度限制（像素）
```

## 使用示例

1. 搜索漫画（基本搜索）：
   ```
   搜漫画 少女
   ```

2. 搜索漫画并指定页码：
   ```
   搜漫画 巨乳 10
   ```

3. 下载漫画的所有章节并发送：
   ```
   看漫画 5f6975c5f6cd8c2deb0b5b05
   ```

## 翻页和批量章节功能

1. **搜索翻页**
   - 命令格式：`搜漫画 关键词 页码`
   - 功能说明：查看搜索结果的不同页面，当搜索结果较多时非常有用
   - 示例：`搜漫画 少女 3` 表示查看关键词"少女"的第3页搜索结果

2. **批量章节下载**
   - 命令格式：`看漫画 漫画ID`
   - 功能说明：一次性下载漫画的所有章节并按顺序发送
   - 处理流程：
     - 先获取该漫画的所有章节信息
     - 依次下载每个章节并处理
     - 自动发送每个章节的内容
   - 注意事项：对于章节较多的漫画，下载过程可能需要较长时间

## 合并转发说明

插件使用两种方式实现合并转发：

1. **API方式**：通过发送请求到`http://127.0.0.1:3000`的API服务，支持群聊和私聊
   - 群聊使用`/send_forward_msg`接口
   - 私聊使用`/send_private_forward_msg`接口

2. **内置方式**：当API方式失败时，使用发功能直接发送。

如果两种方式都失败，会退化为发送单张图片预览。

## 智能图片合并功能

插件采用智能分批合并策略，解决了图片过长的问题：

1. **分批原理**：当图片总高度超过配置的`max_image_height`限制时，会自动分成多个批次，每个批次生成一张合适大小的长图
2. **合并过程**：
   - 首先读取所有图片，计算各自尺寸
   - 按顺序添加图片到当前批次，直到接近高度限制
   - 将当前批次合并为一张长图，开始新的批次
   - 所有批次处理完成后，生成多张长图
3. **发送方式**：所有合并后的长图会通过合并转发的方式一次性发送给用户
4. **调整参数**：可在配置文件中调整`max_image_height`值以适应不同设备的显示需求

所有合并后的图片会保存在`cache/merged`目录下，便于后续查看。

## 依赖

- aiohttp>=3.8.0：处理HTTP请求
- ujson>=5.4.0：JSON处理
- pyyaml>=6.0：YAML配置文件解析
- aiofiles>=0.8.0：异步文件操作
- pillow>=9.0.0：图片处理和合并


## 故障排除

1. **命令无法识别**
   - 确认消息格式正确：命令与关键词之间需要有空格，如`搜漫画 关键词`
   - 检查是否有权限管理插件拦截了消息
   - 查看日志中是否记录了收到消息的信息

2. **下载失败**
   - 确认账号配置正确
   - 检查网络连接和代理设置
   - 确认漫画ID存在且格式正确

3. **图片合并失败**
   - 检查是否安装了Pillow库
   - 确认插件有权限写入缓存目录
   - 尝试调小`max_image_height`值减轻内存压力
   - 如果合并失败，插件会自动回退到单图显示

4. **合并转发失败**
   - 确认API服务可访问（默认地址：`http://127.0.0.1:3000`）
   - 检查插件是否降级到了内置转发或单图片预览

5. **批量下载章节过程中断**
   - 检查网络连接稳定性
   - 如果某章节下载失败，插件会继续处理其他章节
   - 对于章节数量较多的漫画，请确保有足够的存储空间
